<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TV Digital Pro</title>
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <style>
        body { background: #000; color: white; font-family: sans-serif; margin: 0; display: flex; flex-direction: column; align-items: center; }
        
        /* REPRODUCTOR GRANDE CON LÍNEAS FINAS */
        .tv-frame { 
            width: 98%; 
            max-width: 1000px; 
            border: 1px solid #ff8c00; /* Línea más fina como pediste */
            padding: 1px; 
            border-radius: 5px; 
            margin-top: 10px; 
            position: relative; 
        }
        .tv-screen { width: 100%; aspect-ratio: 16/9; background: #000; border-radius: 4px; overflow: hidden; position: relative; }
        #player { width: 100%; height: 100%; object-fit: contain; }

        /* RELOJ QUE DESAPARECE A LOS 5 SEGUNDOS */
        #global-timer { 
            position: absolute; 
            top: 10px; 
            right: 10px; 
            background: rgba(0,0,0,0.6); 
            padding: 3px 8px; 
            border-radius: 3px; 
            color: #ff8c00; 
            font-size: 11px; 
            z-index: 10; 
            border: 0.5px solid #ff8c00; 
            font-family: monospace;
            transition: opacity 1s ease;
            opacity: 1;
        }

        /* CAMPO DE CLAVE DISCRETO */
        .access-area { width: 100%; display: flex; justify-content: center; margin: 5px 0; }
        #key-entry { 
            background: transparent; 
            border: none; 
            color: #0a0a0a; /* Casi invisible */
            text-align: center; 
            font-size: 10px; 
            width: 100px;
            outline: none;
        }

        /* PUBLICIDAD */
        .pub-area { width: 95%; height: 85px; background: #050505; border-radius: 8px; border: 1px solid #111; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        #img-pub { max-height: 100%; object-fit: contain; }

        /* BLOQUEO DE BARRA */
        .plyr--video .plyr__controls .plyr__progress__container { pointer-events: none !important; opacity: 0.1; }

        /* PANEL ADMIN */
        #admin-panel { display: none; width: 95%; background: #111; padding: 20px; border-radius: 12px; border: 1px solid #ff8c00; margin: 20px 0; box-sizing: border-box; }
        input, button { width: 100%; padding: 14px; margin-top: 10px; border-radius: 6px; border: 1px solid #333; background: #000; color: white; }
        button { background: #ff8c00; border: none; font-weight: bold; }
    </style>
</head>
<body>

<div class="tv-frame">
    <div class="tv-screen">
        <div id="global-timer">Cargando...</div>
        <video id="player" playsinline controls></video>
    </div>
</div>

<div class="access-area">
    <input type="password" id="key-entry" placeholder="..." maxlength="10">
</div>

<div class="pub-area">
    <img id="img-pub" src="" alt="Publicidad">
</div>

<div id="admin-panel">
    <h3 style="color:#ff8c00; margin-top:0;">Panel Maestro</h3>
    <input type="text" id="v-url" placeholder="URL del Video .mp4">
    <button onclick="control.add()">Emitir Video</button>
    <input type="text" id="p-url" placeholder="URL de Publicidad" style="margin-top:15px;">
    <button onclick="control.pub()">Cambiar Banner</button>
    <button onclick="control.reset()" style="background:#600; margin-top:20px;">VACIAR LISTA</button>
</div>

<video id="scanner" style="display:none;" preload="metadata"></video>

<script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, set, push, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "TU_API_KEY",
        databaseURL: "TU_DATABASE_URL",
        projectId: "TU_PROJECT_ID",
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const player = new Plyr('#player', { autoplay: true, muted: true, controls: ['play-large', 'play', 'mute', 'volume', 'fullscreen'] });

    const keyInput = document.getElementById('key-entry');
    const timerDisplay = document.getElementById('global-timer');

    // Función para ocultar reloj tras 5 segundos
    function hideTimer() {
        timerDisplay.style.opacity = "1";
        setTimeout(() => { timerDisplay.style.opacity = "0"; }, 5000);
    }

    keyInput.addEventListener('input', () => {
        if (keyInput.value === "7744118520") {
            document.getElementById('admin-panel').style.display = 'block';
            keyInput.style.display = 'none';
            window.scrollTo(0, document.body.scrollHeight);
        }
    });

    let currentUrl = "";
    const T_BASE = 1735689600;

    onValue(ref(db, 'tv_vfinal'), (snap) => {
        const d = snap.val();
        if (!d) return;
        if (d.p) document.getElementById('img-pub').src = d.p;
        const list = d.v ? Object.values(d.v) : [];
        if (list.length > 0) {
            const ahora = Math.floor(Date.now() / 1000);
            const totalD = list.reduce((a, b) => a + b.dur, 0);
            const tEnCiclo = (ahora - T_BASE) % totalD;
            let acum = 0;
            for (let v of list) {
                if (tEnCiclo < acum + v.dur) {
                    const res = Math.ceil((acum + v.dur) - tEnCiclo);
                    timerDisplay.innerText = `-${Math.floor(res/60)}:${(res%60)<10?'0':''}${res%60}`;
                    
                    if (currentUrl !== v.url) {
                        currentUrl = v.url;
                        player.source = { type: 'video', sources: [{ src: v.url }] };
                        player.once('ready', () => { 
                            player.currentTime = tEnCiclo - acum; 
                            player.play(); 
                            hideTimer(); // El reloj aparece 5 seg al cambiar de video
                        });
                    }
                    break;
                }
                acum += v.dur;
            }
        }
    });

    window.control = {
        add: () => {
            const url = document.getElementById('v-url').value;
            const sc = document.getElementById('scanner');
            sc.src = url;
            sc.onloadedmetadata = () => {
                push(ref(db, 'tv_vfinal/v'), { url, dur: sc.duration });
                alert("Sincronizado");
                document.getElementById('v-url').value = "";
            };
        },
        pub: () => { set(ref(db, 'tv_vfinal/p'), document.getElementById('p-url').value); alert("Banner Actualizado"); },
        reset: () => { if(confirm("¿Borrar todo?")) remove(ref(db, 'tv_vfinal/v')); }
    };
</script>
</body>
</html>
