<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TV Live Android</title>
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <style>
        :root { --naranja: linear-gradient(180deg, #ff8c00 0%, #e65100 100%); }
        body { background: #000; color: white; font-family: sans-serif; margin: 0; display: flex; flex-direction: column; align-items: center; overflow-x: hidden; touch-action: manipulation; }
        
        /* REPRODUCTOR */
        .tv-frame { width: 95%; max-width: 850px; background: var(--naranja); padding: 5px; border-radius: 15px; margin-top: 15px; position: relative; box-shadow: 0 0 25px rgba(255,140,0,0.4); }
        .tv-screen { width: 100%; aspect-ratio: 16/9; background: #000; border-radius: 10px; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        #player { width: 100%; height: 100%; object-fit: contain; }

        /* ACTIVADOR SECRETO (Invisible en esquina superior derecha) */
        #secret-touch { position: absolute; top: 0; right: 0; width: 60px; height: 60px; z-index: 999; }

        /* PUBLICIDAD */
        .pub-area { width: 95%; max-width: 850px; height: 90px; margin: 15px 0; background: #0a0a0a; border-radius: 12px; border: 1px solid #222; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        #img-pub { max-height: 100%; object-fit: contain; }

        /* PANEL ADMIN */
        #admin-panel { display: none; width: 95%; max-width: 850px; background: #111; padding: 15px; border-radius: 15px; border: 2px solid #ff8c00; margin-bottom: 40px; box-sizing: border-box; }
        input, button { width: 100%; padding: 12px; margin-top: 10px; border-radius: 8px; border: 1px solid #333; background: #222; color: white; font-size: 16px; -webkit-appearance: none; }
        button { background: var(--naranja); border: none; font-weight: bold; }
        .monitor { background: #000; padding: 10px; height: 100px; overflow-y: auto; font-size: 12px; margin-top: 10px; border: 1px solid #222; color: #ff8c00; }

        @media (orientation: landscape) {
            .tv-frame { width: auto; height: 92vh; margin-top: 5px; }
            .pub-area, #admin-panel { display: none; }
        }
    </style>
</head>
<body>

<div class="tv-frame">
    <div id="secret-touch" onclick="checkSecret()"></div>
    
    <div class="tv-screen">
        <video id="player" playsinline controls></video>
    </div>
</div>

<div class="pub-area">
    <img id="img-pub" src="" alt="Publicidad">
</div>

<div id="admin-panel">
    <h3 style="margin:0; color:#ff8c00;">Panel Maestro (Móvil)</h3>
    <label>URL del Video (.mp4):</label>
    <input type="url" id="v-url" placeholder="Pega el enlace aquí">
    <button onclick="control.add()">Añadir a Programación</button>
    <div id="v-list" class="monitor"></div>
    
    <hr style="border:0.5px solid #222; margin:15px 0;">
    
    <label>Imagen Publicidad:</label>
    <input type="url" id="p-url" placeholder="URL de la imagen">
    <button onclick="control.pub()">Actualizar Banner</button>
    <button onclick="control.reset()" style="background:#600; margin-top:20px; font-size:12px;">VACIAR TODO</button>
</div>

<video id="scanner" style="display:none;" preload="metadata"></video>

<script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, set, push, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "TU_API_KEY",
        databaseURL: "TU_DATABASE_URL",
        projectId: "TU_PROJECT_ID",
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const player = new Plyr('#player', { autoplay: true, muted: true });
    
    let clickCount = 0;
    let clickTimer;
    let currentUrl = "";
    const T_BASE = 1735689600;

    // LÓGICA DE TOQUES SECRETOS (5 toques en 2 segundos)
    window.checkSecret = () => {
        clickCount++;
        clearTimeout(clickTimer);
        clickTimer = setTimeout(() => { clickCount = 0; }, 2000);

        if (clickCount === 5) {
            clickCount = 0;
            const entry = prompt("ACCESO PRIVADO:");
            if (parseInt(entry) * 2 === 17798) { // Clave 8899
                document.getElementById('admin-panel').style.display = 'block';
                window.scrollTo(0, document.body.scrollHeight);
            }
        }
    };

    // SINCRONIZACIÓN
    onValue(ref(db, 'tv_vfinal'), (snap) => {
        const d = snap.val();
        if (!d) return;
        if (d.p) document.getElementById('img-pub').src = d.p;

        const list = d.v ? Object.values(d.v) : [];
        if (list.length > 0) {
            const ahora = Math.floor(Date.now() / 1000);
            const totalD = list.reduce((a, b) => a + b.dur, 0);
            const tEnCiclo = (ahora - T_BASE) % totalD;

            let acum = 0;
            for (let v of list) {
                if (tEnCiclo < acum + v.dur) {
                    if (currentUrl !== v.url) {
                        currentUrl = v.url;
                        player.source = { type: 'video', sources: [{ src: v.url }] };
                        player.once('ready', () => {
                            player.currentTime = tEnCiclo - acum;
                            player.play();
                        });
                    }
                    break;
                }
                acum += v.dur;
            }
        }
    });

    window.control = {
        add: () => {
            const url = document.getElementById('v-url').value;
            const sc = document.getElementById('scanner');
            if(!url) return;
            sc.src = url;
            alert("Analizando video en servidor...");
            sc.onloadedmetadata = () => {
                push(ref(db, 'tv_vfinal/v'), { url: url, dur: sc.duration });
                alert("Sincronizado con éxito.");
                document.getElementById('v-url').value = "";
            };
            sc.onerror = () => alert("Error: Enlace no compatible.");
        },
        pub: () => {
            set(ref(db, 'tv_vfinal/p'), document.getElementById('p-url').value);
            alert("Publicidad actualizada.");
        },
        reset: () => {
            if(confirm("¿Borrar todo?")) remove(ref(db, 'tv_vfinal/v'));
        }
    };

    onValue(ref(db, 'tv_vfinal/v'), (snap) => {
        const div = document.getElementById('v-list');
        div.innerHTML = "";
        snap.forEach(c => { div.innerHTML += `• ${c.val().url.split('/').pop()}<br>`; });
    });
</script>
</body>
    </html>
    
