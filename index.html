<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TV Live - Control Temporal</title>
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <style>
        :root { --naranja: linear-gradient(180deg, #ff8c00 0%, #e65100 100%); }
        body { background: #000; color: white; font-family: sans-serif; margin: 0; display: flex; flex-direction: column; align-items: center; overflow-x: hidden; }
        
        .tv-frame { 
            width: 95%; max-width: 850px; 
            background: var(--naranja); 
            padding: 35px 8px 8px 8px; 
            border-radius: 20px; 
            margin-top: 15px; 
            position: relative; 
            box-shadow: 0 0 35px rgba(255,140,0,0.6);
        }

        /* CUADRITO NARANJA QUE DESAPARECE */
        #secret-trigger { 
            position: absolute; 
            top: 5px; 
            right: 15px; 
            width: 60px; 
            height: 45px; 
            z-index: 9999; 
            background: #ff8c00; /* Naranja sólido al inicio */
            border: 2px solid white;
            border-radius: 8px;
            transition: opacity 1s ease; /* Efecto de desvanecimiento */
        }

        .tv-screen { width: 100%; aspect-ratio: 16/9; background: #000; border-radius: 12px; overflow: hidden; display: flex; align-items: center; justify-content: center; position: relative; }
        #player { width: 100%; height: 100%; object-fit: contain; }

        .plyr--video .plyr__controls .plyr__progress__container { pointer-events: none !important; opacity: 0.1; }
        .timer-box { position: absolute; top: 12px; left: 12px; background: rgba(0,0,0,0.9); padding: 6px 14px; border-radius: 8px; color: #ff8c00; font-size: 13px; z-index: 10; border: 1px solid #ff8c00; font-family: monospace; }

        .pub-area { width: 95%; max-width: 850px; height: 90px; margin: 15px 0; background: #111; border-radius: 15px; border: 1px solid #333; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        #img-pub { max-height: 100%; object-fit: contain; }

        #admin-panel { display: none; width: 92%; max-width: 800px; background: #121212; padding: 25px; border-radius: 20px; border: 2px solid #ff8c00; margin-bottom: 50px; box-sizing: border-box; }
        input, button { width: 100%; padding: 15px; margin-top: 10px; border-radius: 10px; border: 1px solid #444; background: #000; color: white; font-size: 16px; }
        button { background: var(--naranja); border: none; font-weight: bold; }
        .monitor { background: #000; padding: 12px; height: 120px; overflow-y: auto; font-size: 12px; margin-top: 12px; border: 1px solid #222; color: #ff8c00; }
    </style>
</head>
<body>

<div class="tv-frame">
    <div id="secret-trigger"></div>
    
    <div class="tv-screen">
        <div class="timer-box" id="global-timer">Restante: --:--</div>
        <video id="player" playsinline controls></video>
    </div>
</div>

<div class="pub-area">
    <img id="img-pub" src="" alt="Publicidad">
</div>

<div id="admin-panel">
    <h3 style="margin:0; color:#ff8c00;">Panel Maestro</h3>
    <input type="text" id="v-url" placeholder="URL Video .mp4">
    <button onclick="control.add()">Añadir Video</button>
    <div id="v-list" class="monitor"></div>
    <input type="text" id="p-url" placeholder="URL Banner" style="margin-top:20px;">
    <button onclick="control.pub()">Cambiar Banner</button>
    <button onclick="control.reset()" style="background:#800; margin-top:30px;">VACIAR TODO</button>
</div>

<video id="scanner" style="display:none;" preload="metadata"></video>

<script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, set, push, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "TU_API_KEY",
        databaseURL: "TU_DATABASE_URL",
        projectId: "TU_PROJECT_ID",
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const player = new Plyr('#player', { 
        autoplay: true, 
        muted: true, 
        controls: ['play-large', 'play', 'mute', 'volume', 'fullscreen'] 
    });

    let count = 0;
    let timer;
    let currentUrl = "";
    const T_BASE = 1735689600;

    // LÓGICA PARA DESAPARECER EL CUADRO NARANJA
    setTimeout(() => {
        const trigger = document.getElementById('secret-trigger');
        trigger.style.opacity = "0"; // Se vuelve invisible
        // Pero sigue funcionando si tocas ahí, aunque no se vea
    }, 10000); // 10000 milisegundos = 10 segundos

    // DETECTOR DE TOQUES
    document.getElementById('secret-trigger').addEventListener('touchstart', (e) => {
        e.preventDefault();
        count++;
        clearTimeout(timer);
        timer = setTimeout(() => { count = 0; }, 1500);

        if (count === 5) {
            count = 0;
            const pass = prompt("CÓDIGO (10 DÍGITOS):");
            if (pass === "7744118520") {
                document.getElementById('admin-panel').style.display = 'block';
                window.scrollTo(0, document.body.scrollHeight);
            }
        }
    });

    // SINCRONIZACIÓN (IDÉNTICA A LA ANTERIOR)
    onValue(ref(db, 'tv_vfinal'), (snap) => {
        const d = snap.val();
        if (!d) return;
        if (d.p) document.getElementById('img-pub').src = d.p;
        const list = d.v ? Object.values(d.v) : [];
        if (list.length > 0) {
            const ahora = Math.floor(Date.now() / 1000);
            const totalD = list.reduce((a, b) => a + b.dur, 0);
            const tEnCiclo = (ahora - T_BASE) % totalD;
            let acum = 0;
            for (let v of list) {
                if (tEnCiclo < acum + v.dur) {
                    const res = Math.ceil((acum + v.dur) - tEnCiclo);
                    document.getElementById('global-timer').innerText = `Restante: ${Math.floor(res/60)}:${(res%60)<10?'0':''}${res%60}`;
                    if (currentUrl !== v.url) {
                        currentUrl = v.url;
                        player.source = { type: 'video', sources: [{ src: v.url }] };
                        player.once('ready', () => { player.currentTime = tEnCiclo - acum; player.play(); });
                    }
                    break;
                }
                acum += v.dur;
            }
        }
    });

    window.control = {
        add: () => {
            const url = document.getElementById('v-url').value;
            const sc = document.getElementById('scanner');
            sc.src = url;
            alert("Sincronizando...");
            sc.onloadedmetadata = () => {
                push(ref(db, 'tv_vfinal/v'), { url, dur: sc.duration });
                alert("Añadido");
                document.getElementById('v-url').value = "";
            };
        },
        pub: () => { set(ref(db, 'tv_vfinal/p'), document.getElementById('p-url').value); alert("Publicidad lista"); },
        reset: () => { if(confirm("¿Borrar todo?")) remove(ref(db, 'tv_vfinal/v')); }
    };

    onValue(ref(db, 'tv_vfinal/v'), (snap) => {
        const div = document.getElementById('v-list');
        div.innerHTML = "";
        snap.forEach(c => { div.innerHTML += `• ${c.val().url.split('/').pop()}<br>`; });
    });
</script>
</body>
</html>
